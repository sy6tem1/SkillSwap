{% extends 'base-no-nav.html' %}
{% load static %}

{% block content %}
<div class="app-header">
    <h2 class="focus-phrase" id='stepTitle'>Привет!</h2>
</div>

<div class="reg-steps">
    <!-- Шаг 1 -->
    <div class="reg-step active" data-step="1">
        <div class="reg-field-form-container">
            <input
                id="nameInput"
                name="get-name"
                type="text"
                placeholder="Введи своё имя"
                class="reg-field-input"
            >
        </div>
    </div>

    <!-- Шаг 2 -->
    <div class="reg-step" data-step="2">
        <div class="avatar-upload reg-field-form-container">
            <label for="photoInput" class="avatar-placeholder">
                <img id="photoPreview" src="{% static 'assets/images/123.jpg' %}" alt="avatar">
                <span>Добавить фото</span>
            </label>
            <input type="file" id="photoInput" accept="image/*" hidden>
        </div>
    </div>

    <!-- Шаг 3 -->
    <div class="reg-step" data-step="3">
        <div class="skills-step reg-field-form-container">
            <input type="text" id="skillInput" placeholder="Начни вводить навык" class="reg-field-input" autocomplete="off">

        </div>
        <ul id="skillsDropdown" class="skills-dropdown"></ul>
        <div id="selectedSkills" class="selected-skills"></div>
        
    </div>

    <!-- Шаг 4 -->
    <div class="reg-step" data-step="4">
        <div class="reg-field-form-container">
            <input id="telegramInput" type="text" placeholder="@telegram или ссылка" class="reg-field-input">
        </div>
    </div>
</div>

<!-- Кнопка дальше -->
<div class="btn-next-container" onclick="nextStep()">
    <div class="btn-next">
        <button type="button" class="btn-next-text" id="nextBtn">Дальше</button>
    </div>
</div>




<script>
const stepsConfig = {
    1: {title:'Привет!', button:'Дальше'},
    2: {title:'Смотри какая красота!', button:'Почти готово'},
    3: {title:'А что ты умеешь?', button:'Ещё немного'},
    4: {title:'Оставь тг)', button:'Завершить'}
};

let currentStep = 1;
let selectedSkills = [];
const badWords = ['дурак', 'идиот', 'лох'];

// Переход между шагами
function nextStep() {
    const current = document.querySelector(`.reg-step[data-step="${currentStep}"]`);
    const next = document.querySelector(`.reg-step[data-step="${currentStep+1}"]`);

    // Проверка валидности текущего шага
    let valid = true;
    if(currentStep === 1) valid = validateName();       // Имя
    if(currentStep === 3) valid = selectedSkills.length > 0; // Навыки
    if(currentStep === 4) valid = validateTelegram();  // Телеграм

    // Если невалидно, остаёмся на текущем шаге
    if(!valid) return;

    if(!next){ submitRegistration(); return; }

    // Анимация смены шагов
    current.classList.remove("active");
    current.classList.add("prev");
    next.classList.add("active");

    setTimeout(()=>current.classList.remove("prev"), 350);

    currentStep++;
    updateUI();
}

// Обновление заголовка и кнопки
function updateUI() {
    document.getElementById('stepTitle').textContent = stepsConfig[currentStep].title;
    document.querySelector('.btn-next-text').textContent = stepsConfig[currentStep].button;
}

// Валидация имени
function validateName() {
    const input = document.getElementById('nameInput');
    const value = input.value.trim().toLowerCase();
    if(value.length < 2 || badWords.some(w=>value.includes(w))){
        input.value = "";
        input.placeholder = "Такое сюда ввести не получится";
        input.classList.add("error");
        return false;
    } else {
        input.classList.remove("error");
        input.placeholder = "Введи своё имя";
        return true;
    }
}

// Валидация Telegram
function validateTelegram() {
    const input = document.getElementById("telegramInput");
    const value = input.value.trim();
    if(!value || (!value.startsWith("@") && !value.startsWith("https://t.me/"))){
        input.value = "";
        input.classList.add("error");
        input.placeholder = "Неверный Telegram";
        return false;
    } else {
        input.classList.remove("error");
        input.placeholder = "@telegram или ссылка";
        return true;
    }
}

// Аватар
document.getElementById('photoInput').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = event => document.getElementById('photoPreview').src = event.target.result;
    reader.readAsDataURL(file);
});

// Навыки
const skillInput = document.getElementById("skillInput");
const dropdown = document.getElementById("skillsDropdown");
const selectedContainer = document.getElementById("selectedSkills");

skillInput.addEventListener("input", async () => {
    const value = skillInput.value.trim();
    if(!value){ dropdown.style.display="none"; return; }
    const res = await fetch(`/api/skills/?q=${value}`);
    const skills = await res.json();
    dropdown.innerHTML = "";
    skills.forEach(skill=>{
        if(selectedSkills.includes(skill.id)) return;
        const li = document.createElement("li");
        li.textContent = skill.name;
        li.onclick = ()=>addSkill(skill);
        dropdown.appendChild(li);
    });
    dropdown.style.display = skills.length?"block":"none";
});

function addSkill(skill){
    selectedSkills.push(skill.id);

    const chip = document.createElement("div");

    chip.className="skill-chip";
    chip.textContent=skill.name;

    chip.onclick=()=>{
        selectedSkills = selectedSkills.filter(id=>id!==skill.id);
        chip.remove();
    };

    chip.innerHTML = `
        <span class="chip-name">${skill.name}</span>
        <img src="{% static 'assets/icons/Cross.svg' %}" class="skill-chip" alt="remove">`;

    selectedContainer.appendChild(chip);
    dropdown.style.display="none";
    skillInput.value="";
}

// Отправка формы
function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie!==''){
        document.cookie.split(';').forEach(cookie=>{
            cookie=cookie.trim();
            if(cookie.startsWith(name+'=')) cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        });
    }
    return cookieValue;
}

function submitRegistration(){
    const csrftoken = getCookie('csrftoken');
    const formData = new FormData();
    formData.append("name", document.getElementById("nameInput").value);
    formData.append("telegram", document.getElementById("telegramInput").value);
    formData.append("skills", JSON.stringify(selectedSkills));
    const photo = document.getElementById("photoInput").files[0];
    if(photo) formData.append("photo", photo);

    fetch("{% url 'register' %}",{
        method:"POST",
        headers:{"X-CSRFToken":csrftoken},
        body: formData
    }).then(res=>res.json())
      .then(data=>{
        if(data.success) window.location.href="/";
        else alert(data.error||"Ошибка регистрации");
    }).catch(err=>{
        console.error(err);
        alert("Ошибка сервера");
    });
}
</script>


{% endblock %}
